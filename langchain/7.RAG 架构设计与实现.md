# ç¬¬7ç« ï¼šRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ¶æ„è®¾è®¡ä¸å®ç°

# å‰è¨€
å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é²«å°é±¼ã€‚æ˜¯ä¸€å`ä¸å†™å‰ç«¯ä»£ç `çš„å‰ç«¯å·¥ç¨‹å¸ˆï¼Œçƒ­è¡·äºåˆ†äº«éå‰ç«¯çš„çŸ¥è¯†ï¼Œå¸¦é¢†åˆ‡å›¾ä»”é€ƒç¦»åˆ‡å›¾åœˆå­ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ï¼Œå¾®ä¿¡å…¬ä¼—å·ï¼š`ã€Šé²«å°é±¼ä¸æ­£ç»ã€‹`ã€‚æ¬¢è¿ç‚¹èµã€æ”¶è—ã€å…³æ³¨ï¼Œä¸€é”®ä¸‰è¿ï¼ï¼

## ğŸ¯ æœ¬ç« å­¦ä¹ ç›®æ ‡
- å…¨é¢æŒæ¡ RAG çš„ä¸‰å±‚ç»“æ„ï¼šæ£€ç´¢ï¼ˆRetrieveï¼‰â†’ èåˆï¼ˆAugment/Fuseï¼‰â†’ ç”Ÿæˆï¼ˆGenerateï¼‰
- è½åœ°æ•°æ®ç®¡é“ï¼šæ–‡æ¡£åŠ è½½ã€æ¸…æ´—ã€åˆ‡åˆ†ã€å‘é‡åŒ–ã€ç´¢å¼•æ„å»ºã€å¢é‡æ›´æ–°
- æŒæ¡æ£€ç´¢ç­–ç•¥ï¼šTopKã€MMRã€æ—¶é—´æ„ŸçŸ¥ï¼ˆTime-awareï¼‰ã€ä¸ªæ€§åŒ–ï¼ˆUser-awareï¼‰ã€æ··åˆæœç´¢
- æ„å»ºâ€œå¯å¼•ç”¨ã€å¯è¿½æº¯ã€ä½å¹»è§‰â€çš„å›ç­”é“¾ï¼Œå¼ºåˆ¶å¼•ç”¨æ¥æºä¸ç½®ä¿¡åº¦
- ç”¨ Runnable/LangGraph ç¼–æ’å¤æ‚ RAG å·¥ä½œæµï¼Œå¹¶å®ç°å¯è§‚æµ‹å›è°ƒä¸ç¼“å­˜
- åœ¨ Next.js ä¸­æä¾› /api/ingest ä¸ /api/rag æ¥å£ï¼Œæ”¯æŒæµå¼å›ç­”ä¸ç§»åŠ¨ç«¯é€‚é…
- å®æˆ˜é¡¹ç›®ï¼šæ–°é—»ä¸å…¬å‘Šçš„æ—¶æ•ˆå‹ RAG é—®ç­”å¹³å°ï¼ˆå«å¢é‡ ingestion ä¸æ¥æºæƒå¨åº¦ï¼‰

---

## ğŸ“– RAG ç»¼è¿°ä¸æ€»ä½“æ¶æ„

### 7.1 ä¸ºä»€ä¹ˆé€‰æ‹© RAG
- çº¯ç”Ÿæˆï¼ˆç”Ÿæˆå¼ LLMï¼‰å®¹æ˜“â€œå¹»è§‰â€ï¼Œæ— æ³•è®¿é—®ç§æœ‰çŸ¥è¯†ä¸æœ€æ–°æ•°æ®
- ä»…æ£€ç´¢ï¼ˆå…³é”®å­—/è¯­ä¹‰æœç´¢ï¼‰è¿”å›ä¿¡æ¯ç¢ç‰‡ï¼Œç¼ºå°‘ç»¼åˆä¸è¡¨è¾¾
- RAG ç»“åˆä¸¤è€…ï¼šå…ˆæ£€ç´¢ã€Œç›¸å…³ç‰‡æ®µã€ï¼Œå†åŸºäºç‰‡æ®µç”Ÿæˆæœ‰â€œå‡ºå¤„â€çš„ç­”æ¡ˆ

### 7.2 å‚è€ƒæ¶æ„ï¼ˆæ¦‚å¿µå›¾ï¼‰
```
ç”¨æˆ·é—®é¢˜ â†’ é¢„å¤„ç†/åˆ¤å®šå¯å›ç­”æ€§ â†’ æ£€ç´¢å±‚ï¼ˆå‘é‡/å…³é”®è¯/æ··åˆï¼‰ â†’ å€™é€‰èåˆ/å»å†—ä½™/é‡æ’åº
  â†’ ç”Ÿæˆå±‚ï¼ˆå¸¦å¼•ç”¨çš„ Promptï¼‰â†’ å®¡æ ¸ä¸å®ˆæŠ¤ï¼ˆå¼•ç”¨æ ¡éªŒ/å®‰å…¨è¯ï¼‰â†’ è¾“å‡ºï¼ˆç»“æ„åŒ– + å¼•ç”¨ï¼‰
                              â†˜ æ—¥å¿—/æŒ‡æ ‡/ç¼“å­˜/å›æ”¾ï¼ˆLangSmith/è‡ªå»ºï¼‰
```

### 7.3 æ•°æ®ä¸çŠ¶æ€
- æ–‡æ¡£åŸŸï¼šæ¥æºï¼ˆsourceï¼‰ã€æ—¶é—´ï¼ˆpublishedAtï¼‰ã€ä½œè€…/éƒ¨é—¨ã€ç±»å‹ï¼ˆspecã€faqã€newsï¼‰
- åˆ‡åˆ†ç­–ç•¥ï¼šchunkSize/overlap ä¸è¯­ä¹‰è¾¹ç•Œç»“åˆï¼Œé…åˆè¯„æµ‹å†³å®š
- å‘é‡ç´¢å¼•ï¼šæ”¯æŒå¢é‡æ›´æ–°ä¸è½¯åˆ é™¤ï¼›å¤šé›†åˆï¼ˆcollectionï¼‰éš”ç¦»ä¸åŒä¸šåŠ¡åŸŸ
- ä¼šè¯çŠ¶æ€ï¼šçŸ­æœŸæ¶ˆæ¯çª—å£ + é•¿æœŸæ‘˜è¦/äº‹å®å¡ï¼ˆå‚è§ç¬¬3ç« ï¼‰

---

## ğŸ§± ç´¢å¼•æ„å»ºï¼šåŠ è½½/æ¸…æ´—/åˆ‡åˆ†/å‘é‡åŒ–/å…¥åº“

### 7.4 åŠ è½½ï¼ˆLoaderï¼‰ä¸æ¸…æ´—ï¼ˆCleanerï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/loaders.ts
import fs from "node:fs/promises";
import path from "node:path";

export type RawDoc = { id: string; text: string; meta: Record<string, any> };

export async function loadMarkdownDir(dir: string, tag = "default"): Promise<RawDoc[]> {
  const files = await fs.readdir(dir);
  const docs: RawDoc[] = [];
  for (const f of files) {
    if (!f.endsWith(".md")) continue;
    const full = path.join(dir, f);
    const text = await fs.readFile(full, "utf8");
    docs.push({ id: f, text, meta: { source: full, type: "md", tag } });
  }
  return docs;
}

export function clean(text: string): string {
  return text
    .replace(/\r/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .replace(/[\t\u00A0]+/g, " ")
    .trim();
}
```

### 7.5 åˆ‡åˆ†ï¼ˆSplitterï¼‰ä¸æ ‡å‡†åŒ–å…ƒæ•°æ®
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/splitter.ts
export type Chunk = { id: string; text: string; meta: Record<string, any> };

export function split(text: string, size = 900, overlap = 120): string[] {
  const out: string[] = [];
  let i = 0;
  while (i < text.length) {
    const s = text.slice(i, i + size);
    out.push(s);
    i += size - overlap;
  }
  return out;
}

export function toChunks(docs: { id: string; text: string; meta: any }[], size = 900, overlap = 120) {
  const arr: Chunk[] = [];
  for (const d of docs) {
    const t = clean(d.text);
    const parts = split(t, size, overlap);
    parts.forEach((p, idx) => arr.push({ id: `${d.id}#${idx}`, text: p, meta: { ...d.meta, chunkIndex: idx } }));
  }
  return arr;
}

// å¼•å…¥ cleanï¼ˆæ­¤å¤„ç®€åŒ–ï¼Œå¯ä» loaders.ts å¯¼å…¥ï¼‰
function clean(t: string) { return t.replace(/\r/g, "\n").replace(/\n{3,}/g, "\n\n").replace(/[\t\u00A0]+/g, " ").trim(); }
```

### 7.6 å‘é‡åŒ–ä¸å…¥åº“ï¼ˆä»¥ Chroma ä¸ºä¾‹ï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/indexer-chroma.ts
import { Chroma } from "@langchain/community/vectorstores/chroma";
import { OpenAIEmbeddings } from "@langchain/openai";
import { loadMarkdownDir } from "./loaders";
import { toChunks } from "./splitter";
import * as dotenv from "dotenv"; dotenv.config();

export async function buildCollection(dir = "./docs", name = "news") {
  const raw = await loadMarkdownDir(dir, name);
  const chunks = toChunks(raw, 900, 120);
  const texts = chunks.map(c => c.text);
  const metas = chunks.map(c => ({ ...c.meta, id: c.id }));
  const db = await Chroma.fromTexts(texts, metas, new OpenAIEmbeddings({ model: "text-embedding-3-small" }), {
    collectionName: `rag_${name}`,
  });
  return db;
}

export async function openCollection(name = "news") {
  return Chroma.fromExistingCollection(new OpenAIEmbeddings({ model: "text-embedding-3-small" }), { collectionName: `rag_${name}` });
}
```

### 7.7 å¢é‡æ›´æ–°ä¸è½¯åˆ é™¤ï¼ˆæ€è·¯ï¼‰
- æ–‡æ¡£åŠ ç‰ˆæœ¬å·æˆ–å†…å®¹æŒ‡çº¹ï¼ˆhashï¼‰ï¼Œä»…å¯¹å˜æ›´æ¡ç›®é‡å»ºåˆ‡åˆ†ä¸å‘é‡
- ä¿ç•™æ—§å‘é‡å¹¶åŠ  `archived=true` æ ‡è®°ï¼Œç¦»çº¿åˆå¹¶æˆ–å‘¨æœŸæ¸…ç†
- æ›´æ–°æµç¨‹å¼‚æ­¥åŒ–ï¼Œå†™æ“ä½œé™æµï¼›å‰ç«¯æç¤ºâ€œç´¢å¼•æ›´æ–°ä¸­â€

---

## ğŸ” æ£€ç´¢ç­–ç•¥ä¸èåˆ

### 7.8 åŸºç¡€ TopK + MMR å»å†—ä½™
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/retrievers.ts
import { openCollection } from "./indexer-chroma";

export type Hit = { text: string; score?: number; meta?: any };

export async function topK(name: string) {
  const store = await openCollection(name);
  return async (q: string, k = 6, filter?: any): Promise<Hit[]> => {
    const docs = await store.similaritySearchWithScore(q, k, filter);
    return docs.map(([d, s]) => ({ text: d.pageContent, score: s, meta: d.metadata }));
  };
}

export function mmr(hits: Hit[], limit = 5) {
  const out: Hit[] = []; const seen = new Set<string>();
  for (const h of hits) {
    const key = `${h.meta?.source}#${h.meta?.chunkIndex}`;
    if (seen.has(key)) continue; seen.add(key); out.push(h);
    if (out.length >= limit) break;
  }
  return out;
}
```

### 7.9 æ—¶é—´æ„ŸçŸ¥æ£€ç´¢ï¼ˆTime-awareï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/time-aware.ts
import { topK, mmr } from "./retrievers";

type TimeRange = { from?: number; to?: number };

export async function timeAwareRetriever(name: string, range?: TimeRange) {
  const retr = await topK(name);
  return async (q: string) => {
    const filter = range ? { publishedAt: { $gte: range.from, $lte: range.to } } as any : undefined;
    const hits = await retr(q, 12, filter);
    return mmr(hits, 6);
  };
}
```

### 7.10 ä¸ªæ€§åŒ–æ£€ç´¢ï¼ˆUser-awareï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/user-aware.ts
import { topK, mmr } from "./retrievers";

export async function userAwareRetriever(name: string, user: { id: string; dept?: string; tags?: string[] }) {
  const retr = await topK(name);
  return async (q: string) => {
    const filter: any = {};
    if (user.dept) filter.dept = user.dept; // éƒ¨é—¨å†…æ–‡æ¡£ä¼˜å…ˆ
    const hits = await retr(q, 10, Object.keys(filter).length ? filter : undefined);
    // ç®€å•åŠ æƒï¼šåŒ¹é…ç”¨æˆ·å…´è¶£æ ‡ç­¾çš„å¾—åˆ†ç•¥å‡ï¼ˆç¤ºæ„ï¼‰
    const boost = (h: any) => (user.tags || []).some(t => (h.meta?.tags || []).includes(t)) ? 0.05 : 0;
    return mmr(hits.sort((a,b)=> (a.score! - boost(a)) - (b.score! - boost(b))), 6);
  };
}
```

### 7.11 æ··åˆæœç´¢ï¼ˆå…³é”®è¯ + å‘é‡ï¼‰ä¸é‡æ’åº
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/hybrid.ts
import { topK } from "./retrievers";

function keywordSearch(q: string, corpus: { id: string; text: string }[], k = 5) {
  const lower = q.toLowerCase();
  return corpus.map(d => ({ d, s: (d.text.toLowerCase().match(new RegExp(lower, "g")) || []).length }))
    .sort((a,b)=> b.s - a.s).slice(0,k).map(x => ({ text: x.d.text, meta: { id: x.d.id, source: "kw" } }));
}

export async function hybrid(name: string) {
  const retr = await topK(name);
  return async (q: string) => {
    const [vecHits, kwHits] = await Promise.all([
      retr(q, 8),
      Promise.resolve(keywordSearch(q, [{ id: "k1", text: "RAG ç»“åˆæ£€ç´¢ä¸ç”Ÿæˆ" }, { id: "k2", text: "MMR æå‡å¤šæ ·æ€§" }], 4)),
    ]);
    const items = [
      ...vecHits.map(h => ({ ...h, weight: 0.7 * (1 - (h.score ?? 0)) })),
      ...kwHits.map(h => ({ ...h, weight: 0.3 })),
    ];
    return items.sort((a,b)=> b.weight - a.weight).slice(0,6).map(({ weight, ...rest })=> rest);
  };
}
```

---

## ğŸ§© èåˆä¸ç”Ÿæˆï¼šé™ä½å¹»è§‰ï¼Œå¼ºåˆ¶å¼•ç”¨

### 7.12 ç»“æ„åŒ–å›ç­”æ¨¡æ¿ä¸å¼•ç”¨çº¦æŸ
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/prompt.ts
import { ChatPromptTemplate } from "@langchain/core/prompts";

export const answerPrompt = ChatPromptTemplate.fromMessages([
  ["system", `ä½ æ˜¯ä¸¥è°¨çš„ä¼ä¸šçŸ¥è¯†åŠ©æ‰‹ã€‚ä»…åŸºäºâ€œå€™é€‰ç‰‡æ®µâ€ä½œç­”ï¼›è‹¥ä¿¡æ¯ä¸è¶³è¯·å›ç­”â€œæˆ‘ä¸çŸ¥é“â€ã€‚
è¾“å‡ºä¸¥æ ¼ JSONï¼š
{
  "answer": string,
  "citations": [{"source": string, "chunkId": string}],
  "confidence": number // 0~1
}`],
  ["human", `é—®é¢˜ï¼š{question}\nå€™é€‰ç‰‡æ®µï¼š\n{chunks}\nè¯·è¾“å‡º JSONï¼š`],
]);
```

### 7.13 ç”Ÿæˆé“¾ï¼ˆRunnableSequenceï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/answer-chain.ts
import { RunnableSequence } from "@langchain/core/runnables";
import { ChatOpenAI } from "@langchain/openai";
import { JsonOutputParser } from "@langchain/core/output_parsers";
import { answerPrompt } from "./prompt";

export function buildAnswerChain() {
  const llm = new ChatOpenAI({ temperature: 0 });
  const parser = new JsonOutputParser<{ answer: string; citations: {source:string; chunkId:string}[]; confidence:number }>();
  return RunnableSequence.from([
    answerPrompt,
    llm,
    parser,
  ]);
}
```

### 7.14 Guardrailsï¼šå¼•ç”¨æ ¡éªŒä¸äº‹å®æ€§ç²—ç­›
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/guards.ts
export function validateCitations(res: { answer: string; citations: any[] }) {
  const ok = Array.isArray(res.citations) && res.citations.length > 0 && res.citations.every(c => c.source);
  if (!ok) throw new Error("ç¼ºå°‘å¼•ç”¨æˆ–æ ¼å¼é”™è¯¯");
  return res;
}

export function shortCircuitIfEmpty(hits: { text: string }[]) {
  if (!hits || hits.length === 0) throw new Error("NO_CONTEXT");
}
```

### 7.15 ç«¯åˆ°ç«¯ RAG Runnable é“¾
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/rag-pipeline.ts
import { RunnableSequence, RunnableLambda } from "@langchain/core/runnables";
import { buildAnswerChain } from "./answer-chain";
import { hybrid } from "./hybrid";
import { validateCitations, shortCircuitIfEmpty } from "./guards";

export async function buildRagPipeline(name = "news") {
  const retrieve = await hybrid(name);
  const toChunkList = new RunnableLambda(async (q: string) => {
    const hits = await retrieve(q);
    shortCircuitIfEmpty(hits);
    const chunks = hits.map((h, i) => `#${i} [${h.meta?.source || "vec"}] ${String(h.text).replace(/\n/g," ").slice(0,400)}...`).join("\n");
    return { question: q, chunks };
  });

  const answer = buildAnswerChain();
  const check = new RunnableLambda((res: any) => validateCitations(res));

  return RunnableSequence.from([
    toChunkList,
    answer,
    check,
  ]);
}
```

---

## ğŸ§  LangGraphï¼šç”¨çŠ¶æ€å›¾ç¼–æ’ RAG å·¥ä½œæµ

### 7.16 å›¾èŠ‚ç‚¹ï¼šæ£€ç´¢â†’èåˆâ†’å›ç­”â†’å®ˆæŠ¤â†’å›å†™
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/graph.tsï¼ˆä¼ªç¤ºä¾‹ï¼Œä¾èµ–ç‰ˆæœ¬ä»¥æœ¬åœ°ä¸ºå‡†ï¼‰
import { StateGraph } from "@langchain/langgraph";
import { buildRagPipeline } from "./rag-pipeline";

type S = { q: string; result?: any; error?: string };

export async function buildGraph() {
  const graph = new StateGraph<S>({ channels: { q: { value: "" }, result: { value: {} }, error: { value: "" } } });
  graph.addNode("rag", async (s) => {
    try {
      const pipeline = await buildRagPipeline("news");
      const out = await pipeline.invoke(s.q);
      return { result: out };
    } catch (e: any) {
      return { error: e.message };
    }
  });
  graph.addEdge("start", "rag");
  graph.addEdge("rag", "end");
  return graph.compile();
}
```

---

## ğŸŒ Next.js æ¥å£ï¼š/api/ingest ä¸ /api/ragï¼ˆSSE æµå¼ï¼‰

### 7.17 æ–‡æ¡£å…¥åº“æ¥å£
```typescript
// æ–‡ä»¶ï¼šsrc/app/api/ingest/route.ts
import { NextRequest } from "next/server";
import { buildCollection } from "@/src/ch07/indexer-chroma";

export const runtime = "edge";

export async function POST(req: NextRequest) {
  const { dir, name } = await req.json();
  try {
    await buildCollection(dir || "./docs", name || "news");
    return Response.json({ ok: true });
  } catch (e: any) {
    return Response.json({ ok: false, message: e.message }, { status: 500 });
  }
}
```

### 7.18 RAG é—®ç­”ï¼ˆSSEï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/app/api/rag/route.ts
import { NextRequest } from "next/server";
import { buildRagPipeline } from "@/src/ch07/rag-pipeline";

export const runtime = "edge";

export async function POST(req: NextRequest) {
  const { q } = await req.json();
  const encoder = new TextEncoder();
  const stream = new ReadableStream({
    async start(controller) {
      try {
        const pipe = await buildRagPipeline("news");
        controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: "start" })}\n\n`));
        const out = await pipe.invoke(q);
        controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: "result", data: out })}\n\n`));
      } catch (e: any) {
        controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: "error", message: e.message })}\n\n`));
      } finally { controller.close(); }
    }
  });
  return new Response(stream, { headers: { "Content-Type": "text/event-stream", "Cache-Control": "no-cache" } });
}
```

### 7.19 å‰ç«¯æ¶ˆè´¹ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
```tsx
// æ–‡ä»¶ï¼šsrc/app/rag/page.tsx
"use client";
import { useRef, useState } from "react";

export default function RAGPage() {
  const [q, setQ] = useState("");
  const [answer, setAnswer] = useState<any>(null);
  const [err, setErr] = useState("");
  const esRef = useRef<EventSource | null>(null);

  const ask = async () => {
    setAnswer(null); setErr("");
    const res = await fetch("/api/rag", { method: "POST", body: JSON.stringify({ q }) });
    // æœ¬ç¤ºä¾‹ç®€åŒ–ï¼šç›´æ¥ä½¿ç”¨ EventSource è®¿é—®åŒä¸€è·¯ç”±ä»…ä½œæ¼”ç¤ºï¼Œç”Ÿäº§å»ºè®®ç›´æ¥æ¶ˆè´¹å“åº”æµ
    const es = new EventSource("/api/rag");
    esRef.current = es;
    es.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.type === "result") setAnswer(data.data);
      if (data.type === "error") setErr(data.message);
    };
  };

  const stop = () => esRef.current?.close();

  return (
    <main className="max-w-screen-sm mx-auto p-4">
      <div className="flex gap-2">
        <input className="flex-1 border rounded px-3 py-2" value={q} onChange={e=>setQ(e.target.value)} placeholder="æé—®ï¼šä¾‹å¦‚ å…¬å¸æ–°æ”¿ç­–çš„ç”Ÿæ•ˆæ—¶é—´ï¼Ÿ" />
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={ask}>æŸ¥è¯¢</button>
        <button className="px-4 py-2 bg-gray-600 text-white rounded" onClick={stop}>åœæ­¢</button>
      </div>
      {err && <p className="text-red-600 mt-2">{err}</p>}
      {answer && (
        <section className="mt-4 space-y-2">
          <h2 className="font-semibold">å›ç­”</h2>
          <pre className="whitespace-pre-wrap break-words">{JSON.stringify(answer, null, 2)}</pre>
        </section>
      )}
    </main>
  );
}
```

---

## ğŸš€ å®æˆ˜ï¼šæ—¶æ•ˆå‹æ–°é—»/å…¬å‘Š RAG å¹³å°

### 7.20 éœ€æ±‚ä¸çº¦æŸ
- æ•°æ®å¤šæºï¼šå®˜ç½‘å…¬å‘Šã€è´¢æŠ¥æ‘˜è¦ã€å†…éƒ¨é€šçŸ¥ï¼ˆéƒ¨é—¨ç»´åº¦ï¼‰
- å¼ºæ—¶æ•ˆï¼šè¿‘æœŸå†…å®¹åº”æœ‰æ›´é«˜æƒé‡ï¼›è¿‡æœŸå†…å®¹é™æƒæˆ–è¿‡æ»¤
- å¯è¿½æº¯ï¼šæ¯æ¡å›ç­”å¿…é¡»æœ‰å¼•ç”¨ï¼›å¼•ç”¨éœ€å«æ¥æºé“¾æ¥ä¸å‘å¸ƒæ—¶é—´
- ç§»åŠ¨ä¼˜å…ˆï¼šåˆ—è¡¨å¡ç‰‡åŒ–ï¼Œç‚¹å‡»å±•å¼€å¼•ç”¨ä¸åŸæ–‡é“¾æ¥

### 7.21 æ’åºç­–ç•¥
- ç»¼åˆæƒé‡ï¼š`score = Î±Â·è¯­ä¹‰ç›¸ä¼¼ + Î²Â·æ—¶é—´è¡°å‡ + Î³Â·æ¥æºæƒå¨åº¦ + Î´Â·ä¸ªæ€§åŒ–åå¥½`
- æ—¶é—´è¡°å‡ï¼š`decay = exp(-Î» Â· days)`ï¼Œè¿‘æœŸæ›´é«˜
- æ¥æºæƒå¨ï¼šå®˜ç½‘ > è¡Œä¸šåä¼š > ç¤¾åª’

### 7.22 å…³é”®ä»£ç ï¼ˆæ’åºä¸åˆå¹¶ï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch07/ranker.ts
export function rank(hits: { text: string; meta: any; score?: number }[], now = Date.now()) {
  function decay(ts?: number) {
    if (!ts) return 1; const days = (now - ts) / (24*3600*1000); const Î» = 0.05; return Math.exp(-Î»*days);
  }
  function authority(src?: string) {
    if (!src) return 0.8; if (src.includes("official")) return 1.0; if (src.includes("association")) return 0.9; return 0.8;
  }
  return hits.map(h => ({
    ...h,
    final: 0.6*(1 - (h.score ?? 0)) + 0.25*decay(h.meta?.publishedAt) + 0.15*authority(h.meta?.source || "")
  })).sort((a,b)=> b.final - a.final);
}
```

### 7.23 UI ç»†èŠ‚
- åˆ—è¡¨å±•ç¤ºï¼šæ ‡é¢˜ã€æ¥æºã€å‘å¸ƒæ—¶é—´ã€ç›¸ä¼¼åº¦/ç½®ä¿¡åº¦
- è¯¦æƒ…æ¡†ï¼šå¼•ç”¨ç‰‡æ®µã€åŸæ–‡é“¾æ¥ã€å…³é”®å¥é«˜äº®
- ç©ºç»“æœï¼šæä¾›â€œæ¢ä¸ªé—®æ³•/é€‰æ‹©æ—¶é—´èŒƒå›´â€çš„å¼•å¯¼

---

## âš™ï¸ å·¥ç¨‹ä¸ä¼˜åŒ–

### 7.24 ç¼“å­˜ä¸å¹¶å‘
- è¾“å…¥æŒ‡çº¹ï¼ˆhashï¼‰â†’ æ£€ç´¢ç»“æœç¼“å­˜ï¼ˆçŸ­æœŸï¼‰ï¼Œé™ä½ QPS å³°å€¼
- LLM è¾“å‡ºç¼“å­˜ï¼šå¯¹åŒé—®é¢˜çŸ­æœŸå…±äº«ï¼Œç¼“å­˜æ³¨å…¥å¼•ç”¨ä¸ç½®ä¿¡åº¦ä»¥ä¾¿ç›´å‡º
- æ‰¹å¤„ç†åµŒå…¥ï¼š`embeddings.embedDocuments` åˆå¹¶è¯·æ±‚

### 7.25 æˆæœ¬ä¸æ—¶å»¶
- åˆ†å—ä¸ TopKï¼šæ›´å°çš„ chunk + åˆç† TopKï¼Œå‡å°‘ context token
- Rerank é™çº§ï¼šåœ¨è´Ÿè½½é«˜æ—¶è·³è¿‡é‡æ’ï¼Œä»…ç”¨ MMR
- å‘é‡æ¨¡å‹é€‰æ‹©ï¼š`text-embedding-3-small` æ€§ä»·æ¯”é«˜ï¼›éœ€é«˜ç²¾åº¦æ—¶å†ä¸Šå¤§æ¨¡å‹

### 7.26 å¹»è§‰ä¸å®‰å…¨
- å¼ºåˆ¶å¼•ç”¨ä¸â€œæˆ‘ä¸çŸ¥é“â€è·¯å¾„ï¼›å¼•ç”¨ç¼ºå¤±ç›´æ¥æŠ¥é”™/é‡è¯•
- æ•æ„Ÿè¯ä¸åˆè§„æ ¡éªŒï¼ˆå…³é”®è¯/æ­£åˆ™/åµŒå…¥åˆ†ç±»å™¨ï¼‰ï¼Œæ‹’ç­”ä¸å¼•å¯¼
- è®°å½•â€œä¸å¯å›ç­”â€é—®é¢˜ï¼Œä½œä¸ºè¯­æ–™å»ºè®¾ä¸ FAQ è¡¥é½çš„è¾“å…¥

### 7.27 å¯è§‚æµ‹æ€§
- å›è°ƒï¼ˆCallbackï¼‰ä¸ŠæŠ¥ï¼šæ£€ç´¢æ•°é‡ã€TopK å‘½ä¸­ç‡ã€Rerank æ˜¯å¦å¼€å¯ã€æœ€ç»ˆ token ä½¿ç”¨
- æ—¥å¿—ï¼šRunId è´¯ç©¿ï¼›é“¾è·¯çº§å»¶è¿Ÿç›‘æ§ï¼›é”™è¯¯åˆ†ç±»ï¼ˆNO_CONTEXTã€INVALID_CITATIONSã€TIMEOUTï¼‰
- å›æ”¾ï¼šä¿å­˜é—®é¢˜ã€å‘½ä¸­ç‰‡æ®µã€æœ€ç»ˆå›ç­”ä¸å¼•ç”¨ï¼Œç”¨äºè¯„å®¡

---

## ğŸ§ª è¯„æµ‹ä¸æŒç»­æ”¹è¿›
- Golden Setï¼šçœŸå®é—®é¢˜ + æ ‡å‡†ç­”æ¡ˆ + å¿…è¦å¼•ç”¨æ¸…å•
- ç¦»çº¿è¯„æµ‹ï¼šRecall@Kã€MRRã€Citation Accuracyã€Faithfulness
- åœ¨çº¿è¯„æµ‹ï¼šæ»¡æ„åº¦ã€äººå·¥æ¥ç®¡ç‡ã€è¿½é—®ç‡ã€å¹³å‡å»¶è¿Ÿã€æˆæœ¬
- A/Bï¼šchunkSize/overlapã€TopKã€MMRã€æ··åˆæƒé‡ã€Rerank å¼€å…³ä¸æ¨¡å‹å¯¹æ¯”

---

## ğŸ“š å»¶ä¼¸é“¾æ¥
- LangChain.js æ–‡æ¡£ï¼ˆRAGï¼‰ï¼š`https://js.langchain.com/`
- LangGraphï¼š`https://langchain-ai.github.io/langgraph/`
- Chromaï¼š`https://docs.trychroma.com/`
- Reranking å‚è€ƒï¼ˆCohere/Jina/ColBERT ç­‰ï¼‰

---

## âœ… æœ¬ç« å°ç»“
- æ„å»ºäº†å®Œæ•´çš„ RAG æµç¨‹ï¼šç´¢å¼•â†’æ£€ç´¢â†’èåˆâ†’ç”Ÿæˆâ†’å®ˆæŠ¤â†’å¯è§‚æµ‹
- å®ç°äº†æ—¶é—´/ä¸ªæ€§åŒ–/æ··åˆæ£€ç´¢ä¸æƒé‡æ’åºï¼Œé™ä½å¹»è§‰å¹¶ä¿è¯å¯è¿½æº¯
- ç”¨ Runnable ä¸ LangGraph ç¼–æ’å·¥ä½œæµï¼Œå¹¶åœ¨ Next.js ä¸­æä¾› API ä¸å‰ç«¯
- å½¢æˆäº†è¯„æµ‹ä¸è¿­ä»£é—­ç¯ï¼Œå®ç°ç”Ÿäº§å¯ç”¨çš„ RAG ä½“ç³»

## ğŸ¯ ä¸‹ç« é¢„å‘Š
ä¸‹ä¸€ç« ã€ŠAgent æ™ºèƒ½ä»£ç†ç³»ç»Ÿå¼€å‘ã€‹ä¸­ï¼Œæˆ‘ä»¬å°†ï¼š
- æ„å»ºå…·å¤‡å·¥å…·è°ƒç”¨ã€è®¡åˆ’åˆ†è§£ä¸å¤šè½®æ¨ç†çš„ Agent
- é›†æˆæ£€ç´¢å·¥å…·ä¸ä»£ç æ‰§è¡Œç¯å¢ƒï¼Œæ‰“é€ æ›´å¼ºçš„ä»»åŠ¡å®Œæˆèƒ½åŠ›
- ç”¨ LangGraph å®ç° Multi-Agent åä½œä¸å†²çªè§£å†³

> æœ€åæ„Ÿè°¢é˜…è¯»ï¼æ¬¢è¿å…³æ³¨æˆ‘ï¼Œå¾®ä¿¡å…¬ä¼—å·ï¼š`ã€Šé²«å°é±¼ä¸æ­£ç»ã€‹`ã€‚æ¬¢è¿ç‚¹èµã€æ”¶è—ã€å…³æ³¨ï¼Œä¸€é”®ä¸‰è¿ï¼ï¼ï¼
