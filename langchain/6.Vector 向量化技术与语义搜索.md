# ç¬¬6ç« ï¼šVector å‘é‡åŒ–æŠ€æœ¯ä¸è¯­ä¹‰æœç´¢

# å‰è¨€
å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é²«å°é±¼ã€‚æ˜¯ä¸€å`ä¸å†™å‰ç«¯ä»£ç `çš„å‰ç«¯å·¥ç¨‹å¸ˆï¼Œçƒ­è¡·äºåˆ†äº«éå‰ç«¯çš„çŸ¥è¯†ï¼Œå¸¦é¢†åˆ‡å›¾ä»”é€ƒç¦»åˆ‡å›¾åœˆå­ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ï¼Œå¾®ä¿¡å…¬ä¼—å·ï¼š`ã€Šé²«å°é±¼ä¸æ­£ç»ã€‹`ã€‚æ¬¢è¿ç‚¹èµã€æ”¶è—ã€å…³æ³¨ï¼Œä¸€é”®ä¸‰è¿ï¼ï¼

## ğŸ¯ æœ¬ç« å­¦ä¹ ç›®æ ‡
- ç†è§£æ–‡æœ¬å‘é‡ï¼ˆEmbeddingï¼‰çš„åŸç†ä¸å¸¸è§åº¦é‡æ–¹å¼ï¼ˆcosineã€dotã€L2ï¼‰
- æŒæ¡æ–‡æ¡£åŠ è½½ã€æ¸…æ´—ã€åˆ†å—ä¸å‘é‡åŒ–çš„å·¥ç¨‹æµç¨‹
- ç†Ÿç»ƒä½¿ç”¨ LangChain.js é›†æˆ Chroma/Pinecone/Weaviate ç­‰å‘é‡æ•°æ®åº“
- ä¼šæ„å»ºæ£€ç´¢å™¨ï¼ˆRetrieverï¼‰ï¼Œå®ç° TopKã€MMRã€Metadata Filter ä¸æ··åˆæœç´¢
- èƒ½åœ¨ Next.js ä¸­è½åœ°è¯­ä¹‰æœç´¢ API ä¸å‰ç«¯ç•Œé¢ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
- å®Œæˆâ€œä¼ä¸šæ–‡æ¡£è¯­ä¹‰æœç´¢ + å¿«é€Ÿé—®ç­”â€å®æˆ˜é¡¹ç›®ï¼Œå…·å¤‡ç”Ÿäº§ä¼˜åŒ–ä¸é”™è¯¯å¤„ç†èƒ½åŠ›

---

## ğŸ“– ç†è®ºåŸºç¡€ï¼šå‘é‡ä¸è¯­ä¹‰ç›¸ä¼¼

### 6.1 Embedding æ˜¯ä»€ä¹ˆ
- å°†è‡ªç„¶è¯­è¨€ï¼ˆæ–‡æœ¬ã€å…³é”®è¯ã€å¥å­ã€æ®µè½ï¼‰æ˜ å°„åˆ°é«˜ç»´ç¨ å¯†å‘é‡ç©ºé—´
- è¯­ä¹‰ç›¸ä¼¼çš„æ–‡æœ¬åœ¨ç©ºé—´ä¸­â€œè·ç¦»æ›´è¿‘â€
- å¸¸ç”¨äºï¼šè¯­ä¹‰æœç´¢ã€RAGã€æ¨èå¬å›ã€èšç±»ã€å»é‡ã€å¼‚å¸¸æ£€æµ‹

### 6.2 å¸¸è§ç›¸ä¼¼åº¦åº¦é‡
- ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosineï¼‰ï¼šè¡¡é‡å¤¹è§’ï¼Œæœ€å¸¸è§ï¼ŒèŒƒå›´ [-1,1]
- ç‚¹ç§¯ï¼ˆDot Productï¼‰ï¼šä¸å‘é‡é•¿åº¦ç›¸å…³ï¼›éƒ¨åˆ†æ¨¡å‹æ¨èä½¿ç”¨
- æ¬§æ°è·ç¦»ï¼ˆL2ï¼‰ï¼šè·ç¦»è¶Šå°è¶Šç›¸ä¼¼

### 6.3 æ–‡æœ¬åˆ†å—ä¸ä¸Šä¸‹æ–‡çª—å£
- LLM/RAG å¸¸ç”¨â€œæ–‡æ¡£åˆ†å—ï¼ˆchunkingï¼‰â€ç­–ç•¥ï¼šå›ºå®šé•¿åº¦ã€é‡å çª—å£ã€å¥å­/æ®µè½è¾¹ç•Œå¯¹é½
- ç›®æ ‡ï¼šç¡®ä¿æ£€ç´¢åˆ°çš„å—â€œè¯­ä¹‰å®Œæ•´â€ï¼ŒåŒæ—¶æ§åˆ¶ token æˆæœ¬
- åˆ†å—è¿‡å¤§ï¼šæ£€ç´¢ç²—ï¼›è¿‡å°ï¼šè¯­ä¹‰ç ´ç¢ï¼›éœ€ç»“åˆè¯„æµ‹è°ƒä¼˜

### 6.4 æ£€ç´¢å™¨ç­–ç•¥
- TopK æœ€è¿‘é‚»ï¼šæœ€åŸºç¡€ï¼ˆæŒ‰ç›¸ä¼¼åº¦æ’åºå–å‰ Kï¼‰
- MMRï¼ˆMaximal Marginal Relevanceï¼‰ï¼šåœ¨ç›¸å…³æ€§ä¸å¤šæ ·æ€§ä¹‹é—´å¹³è¡¡ï¼Œé™ä½é‡å¤
- Metadata Filterï¼šåŸºäºç»“æ„åŒ–å…ƒæ•°æ®çš„ç­›é€‰ï¼ˆæ—¶é—´ã€ä½œè€…ã€ç±»å‹ã€éƒ¨é—¨ç­‰ï¼‰
- Rerankï¼šç”¨æ›´å¼ºæ¨¡å‹ï¼ˆCross-Encoder/LLMï¼‰å¯¹å€™é€‰è¿›è¡Œé‡æ’
- æ··åˆæœç´¢ï¼šBM25ï¼ˆå…³é”®è¯ï¼‰+ å‘é‡æœç´¢ èåˆï¼Œæé«˜é²æ£’æ€§

---

## ğŸ› ï¸ ç¯å¢ƒä¸ä¾èµ–

```bash
# åŸºç¡€ä¾èµ–
npm i @langchain/core @langchain/community @langchain/openai

# å¯é€‰ï¼šæœ¬åœ°å‘é‡åº“ï¼ˆChromaï¼‰
npm i chromadb

# å¯é€‰ï¼šPinecone/Weaviate å®¢æˆ·ç«¯ï¼ˆç¤ºæ„ï¼‰
# npm i @pinecone-database/pinecone weaviate-ts-client

# å¼€å‘å·¥å…·
npm i -D tsx typescript @types/node dotenv
```

`.env` ç¤ºä¾‹ï¼š
```bash
OPENAI_API_KEY=sk-xxx
# PINECONE_API_KEY=...
# WEAVIATE_HOST=...
```

---

## ğŸ’» æ–‡æ¡£åŠ è½½ã€æ¸…æ´—ä¸åˆ†å—

### 6.5 æ–‡æ¡£åŠ è½½ï¼ˆç¤ºä¾‹ï¼šæœ¬åœ° Markdown/PDF/URLï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/loaders.ts
import fs from "node:fs/promises";
import path from "node:path";

export type RawDoc = { id: string; text: string; meta?: Record<string, any> };

export async function loadMarkdownDir(dir: string): Promise<RawDoc[]> {
  const files = await fs.readdir(dir);
  const docs: RawDoc[] = [];
  for (const f of files) {
    if (!f.endsWith(".md")) continue;
    const full = path.join(dir, f);
    const text = await fs.readFile(full, "utf8");
    docs.push({ id: f, text, meta: { source: full, type: "md" } });
  }
  return docs;
}

// TODO: PDFã€URL å¯æŒ‰éœ€æ‰©å±•ï¼ˆä¾‹å¦‚ pdf-parse / cheerio æŠ“å–ï¼‰ï¼Œæ­¤å¤„ç•¥
```

### 6.6 æ¸…æ´—ä¸åˆ†å—
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/chunk.ts
export type Chunk = { id: string; text: string; meta?: Record<string, any> };

export function clean(text: string): string {
  return text
    .replace(/\r/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .replace(/[\t\u00A0]+/g, " ")
    .trim();
}

export function splitIntoChunks(
  text: string,
  chunkSize = 800,
  overlap = 100
): string[] {
  const out: string[] = [];
  let i = 0;
  while (i < text.length) {
    const slice = text.slice(i, i + chunkSize);
    out.push(slice);
    i += chunkSize - overlap;
  }
  return out;
}

export function makeChunks(
  docs: { id: string; text: string; meta?: Record<string, any> }[],
  chunkSize = 800,
  overlap = 100
): Chunk[] {
  const chunks: Chunk[] = [];
  for (const d of docs) {
    const t = clean(d.text);
    const parts = splitIntoChunks(t, chunkSize, overlap);
    parts.forEach((p, idx) => {
      chunks.push({ id: `${d.id}#${idx}`, text: p, meta: { ...(d.meta || {}), chunkIndex: idx } });
    });
  }
  return chunks;
}
```

---

## ğŸ”¢ å‘é‡åŒ–ä¸å­˜å‚¨ï¼ˆChroma ç¤ºä¾‹ï¼‰

### 6.7 OpenAI Embeddings + Chroma å¿«é€Ÿå…¥é—¨
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/chroma-basic.ts
import { OpenAIEmbeddings } from "@langchain/openai";
import { Chroma } from "@langchain/community/vectorstores/chroma";
import { v4 as uuid } from "uuid";
import { makeChunks } from "./chunk";
import { loadMarkdownDir } from "./loaders";
import * as dotenv from "dotenv";
dotenv.config();

export async function buildChromaFromDir(dir = "./docs") {
  const raw = await loadMarkdownDir(dir);
  const chunks = makeChunks(raw, 800, 120);

  const texts = chunks.map(c => c.text);
  const metadatas = chunks.map(c => ({ ...c.meta, id: c.id }));
  const ids = chunks.map(() => uuid());

  const db = await Chroma.fromTexts(
    texts,
    metadatas,
    new OpenAIEmbeddings({ model: "text-embedding-3-small" }),
    { collectionName: "docs" }
  );
  await db.addVectors([], [], []); // å ä½ï¼Œç¡®ä¿åˆå§‹åŒ–ï¼ˆæŸäº›ç‰ˆæœ¬ä¸éœ€è¦ï¼‰
  return db;
}

if (require.main === module) {
  buildChromaFromDir().then(() => console.log("Chroma ready"));
}
```

### 6.8 æŸ¥è¯¢ä¸ç›¸ä¼¼åº¦æœç´¢
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/chroma-query.ts
import { buildChromaFromDir } from "./chroma-basic";

export async function searchChroma(q: string) {
  const db = await buildChromaFromDir();
  const docs = await db.similaritySearch(q, 5); // TopK=5
  for (const d of docs) {
    console.log("[hit]", d.metadata?.id, d.metadata?.source, "\n", d.pageContent.slice(0, 120), "...\n");
  }
}

if (require.main === module) searchChroma("å¦‚ä½•ä½¿ç”¨ LangChain.js æ„å»ºé“¾ï¼Ÿ");
```

### 6.9 å¸¦è¿‡æ»¤ä¸ MMR æ£€ç´¢
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/chroma-advanced.ts
import { OpenAIEmbeddings } from "@langchain/openai";
import { Chroma } from "@langchain/community/vectorstores/chroma";

export async function chromaAdvanced(q: string) {
  const db = await Chroma.fromExistingCollection(
    new OpenAIEmbeddings({ model: "text-embedding-3-small" }),
    { collectionName: "docs" }
  );

  // è¿‡æ»¤ï¼šä¾‹å¦‚ä»…æ£€ç´¢ type=md çš„å†…å®¹
  const filter = { type: "md" } as any;

  // TopK + MMRï¼ˆå¤šæ ·æ€§ï¼‰
  const results = await db.similaritySearch(q, 8, filter);
  // è‡ªå®šä¹‰ MMRï¼šæ­¤å¤„ç®€åŒ–ï¼ŒçœŸå®å¯ç”¨å‘é‡ä¸è´ªå¿ƒå»å†—ä½™
  const unique: any[] = [];
  const seen = new Set<string>();
  for (const r of results) {
    const k = r.metadata?.source + "#" + r.metadata?.chunkIndex;
    if (!seen.has(k)) { seen.add(k); unique.push(r); }
    if (unique.length >= 5) break;
  }
  return unique;
}

if (require.main === module) {
  chromaAdvanced("æ€§èƒ½ä¼˜åŒ–è¦ç‚¹").then(r => console.log("hits:", r.length));
}
```

---

## â˜ï¸ Pinecone/Weaviateï¼ˆæ¥å£ç¤ºæ„ï¼‰

### 6.10 Pinecone
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/pinecone.ts
// ä¼ªç¤ºæ„ï¼šå®é™…æ¥å…¥è¯·å‚è€ƒ @langchain/community çš„ PineconeVectorStore
// import { Pinecone } from "@pinecone-database/pinecone";
// import { PineconeStore } from "@langchain/community/vectorstores/pinecone";

export async function pineconeDemo() {
  // const pc = new Pinecone({ apiKey: process.env.PINECONE_API_KEY! });
  // const index = pc.Index("my-index");
  // const store = await PineconeStore.fromTexts([...], [...], embeddings, { pineconeIndex: index });
  // const res = await store.similaritySearch("query", 5);
}
```

### 6.11 Weaviate
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/weaviate.ts
// ä¼ªç¤ºæ„ï¼šå®é™…æ¥å…¥è¯·å‚è€ƒç¤¾åŒº VectorStore å®ç°
// import weaviate from "weaviate-ts-client";
// import { WeaviateStore } from "@langchain/community/vectorstores/weaviate";

export async function weaviateDemo() {
  // const client = weaviate.client({ host: process.env.WEAVIATE_HOST! });
  // const store = await WeaviateStore.fromTexts([...], [...], embeddings, { client, indexName: "docs" });
  // const res = await store.similaritySearch("query", 5);
}
```

---

## ğŸ” æ„å»º Retriever ä¸æ··åˆæœç´¢

### 6.12 åŸºç¡€ Retriever
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/retriever-basic.ts
import { OpenAIEmbeddings } from "@langchain/openai";
import { Chroma } from "@langchain/community/vectorstores/chroma";

export type Retrieved = { text: string; source?: string; score?: number; meta?: any };

export async function createRetriever() {
  const store = await Chroma.fromExistingCollection(
    new OpenAIEmbeddings({ model: "text-embedding-3-small" }),
    { collectionName: "docs" }
  );
  return async (q: string, k = 5, filter?: any): Promise<Retrieved[]> => {
    const hits = await store.similaritySearchWithScore(q, k, filter);
    return hits.map(([d, s]) => ({ text: d.pageContent, source: d.metadata?.source, score: s, meta: d.metadata }));
  };
}
```

### 6.13 å…³é”®è¯ï¼ˆBM25ï¼‰+ å‘é‡çš„æ··åˆ
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/hybrid.ts
import { createRetriever } from "./retriever-basic";

function keywordSearch(query: string, corpus: { id: string; text: string }[], k = 5) {
  const q = query.toLowerCase();
  const scored = corpus.map(d => ({ d, s: (d.text.toLowerCase().match(new RegExp(q, "g")) || []).length }));
  return scored.sort((a,b) => b.s - a.s).slice(0, k).map(x => x.d);
}

export async function hybridSearch(query: string) {
  const retr = await createRetriever();
  const local = [
    { id: "k1", text: "LangChain æä¾› Runnable/Prompt/Agent ç­‰" },
    { id: "k2", text: "å‘é‡æœç´¢é€šå¸¸ç»“åˆ BM25 æå‡é²æ£’æ€§" },
  ];

  const [vecHits, kwHits] = await Promise.all([
    retr(query, 5),
    Promise.resolve(keywordSearch(query, local, 3)),
  ]);

  const items = [
    ...vecHits.map(h => ({ text: h.text, score: (1 - (h.score ?? 0)) * 0.7, source: h.source })),
    ...kwHits.map(h => ({ text: h.text, score: 0.3, source: "keyword" })),
  ];
  return items.sort((a,b)=> b.score - a.score).slice(0, 5);
}

if (require.main === module) {
  hybridSearch("å‘é‡ æœç´¢").then(r => console.log(r));
}
```

### 6.14 Rerankï¼ˆé‡æ’åºï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/rerank.ts
// ä¼ªå®ç°ï¼šå®é™…å¯ç”¨ Cross-Encoder æˆ– @langchain/community çš„ Rerankerï¼ˆå¦‚ Cohereã€Jinaï¼‰
export async function simpleRerank(query: string, candidates: { text: string }[]) {
  const terms = query.toLowerCase().split(/\s+/);
  return candidates
    .map(c => ({ c, s: terms.reduce((acc, t)=> acc + (c.text.toLowerCase().includes(t) ? 1 : 0), 0) }))
    .sort((a,b)=> b.s - a.s)
    .map(x => x.c);
}
```

---

## ğŸ¤– RAG å¿«é€Ÿé—®ç­”é“¾ï¼ˆæ£€ç´¢â†’èåˆâ†’å›ç­”ï¼‰

### 6.15 ç»„è£… QA Chain
```typescript
// æ–‡ä»¶ï¼šsrc/ch06/rag-qa.ts
import { ChatOpenAI } from "@langchain/openai";
import { ChatPromptTemplate } from "@langchain/core/prompts";
import { JsonOutputParser } from "@langchain/core/output_parsers";
import { createRetriever } from "./retriever-basic";

const answerPrompt = ChatPromptTemplate.fromMessages([
  ["system", `ä½ æ˜¯å¯é çš„æŠ€æœ¯åŠ©æ‰‹ã€‚è¯·ä»…åŸºäºâ€œæ£€ç´¢åˆ°çš„ç‰‡æ®µâ€å›ç­”é—®é¢˜ã€‚
è‹¥èµ„æ–™ä¸è¶³ï¼Œè¯·è¯´â€œæˆ‘ä¸çŸ¥é“â€ã€‚
ä¸¥æ ¼è¾“å‡ºï¼š
{
  "answer": string,
  "quotes": string[]
}`],
  ["human", `é—®é¢˜ï¼š{question}\næ£€ç´¢ç‰‡æ®µï¼š\n{chunks}\nè¯·å›ç­”ï¼š`],
]);

export async function buildQA() {
  const retr = await createRetriever();
  const llm = new ChatOpenAI({ temperature: 0 });
  const parser = new JsonOutputParser<{ answer: string; quotes: string[] }>();

  return async (q: string) => {
    const hits = await retr(q, 6);
    const merged = hits.map(h => `- ${h.text.replace(/\n/g, ' ').slice(0, 400)}...`).join("\n");
    const res = await answerPrompt
      .pipe(llm)
      .pipe(parser)
      .invoke({ question: q, chunks: merged });
    return { ...res, rawHits: hits };
  };
}

if (require.main === module) {
  (async () => {
    const qa = await buildQA();
    const out = await qa("å¦‚ä½•è®¾è®¡å‘é‡æ£€ç´¢çš„åˆ†å—ç­–ç•¥ï¼Ÿ");
    console.log(out);
  })();
}
```

---

## ğŸŒ Next.js è½åœ°ï¼šè¯­ä¹‰æœç´¢ API ä¸ç•Œé¢

### 6.16 APIï¼ˆRoute Handlerï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/app/api/search/route.ts
import { NextRequest } from "next/server";
import { hybridSearch } from "@/src/ch06/hybrid";

export const runtime = "edge";

export async function POST(req: NextRequest) {
  const { q } = await req.json();
  const items = await hybridSearch(q);
  return Response.json({ ok: true, items });
}
```

### 6.17 å‰ç«¯é¡µï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
```tsx
// æ–‡ä»¶ï¼šsrc/app/search/page.tsx
"use client";
import { useState } from "react";

export default function SearchPage() {
  const [q, setQ] = useState("");
  const [items, setItems] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");

  const go = async () => {
    try {
      setLoading(true); setErr("");
      const res = await fetch("/api/search", { method: "POST", body: JSON.stringify({ q }) });
      const data = await res.json();
      setItems(data.items || []);
    } catch (e: any) {
      setErr(e.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <main className="mx-auto max-w-screen-sm p-4">
      <div className="flex gap-2">
        <input className="flex-1 border rounded px-3 py-2" placeholder="è¾“å…¥æœç´¢å…³é”®è¯" value={q} onChange={e=>setQ(e.target.value)} />
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={go} disabled={loading}>æœç´¢</button>
      </div>
      {err && <p className="text-red-600 mt-2">{err}</p>}
      <ul className="mt-4 space-y-3">
        {items.map((it, i) => (
          <li key={i} className="border rounded p-3">
            <div className="text-sm text-gray-500">æ¥æºï¼š{it.source || "æ··åˆ"}</div>
            <div className="mt-1 whitespace-pre-wrap break-words leading-relaxed">{it.text}</div>
          </li>
        ))}
      </ul>
    </main>
  );
}
```

---

## ğŸš€ å®æˆ˜é¡¹ç›®ï¼šä¼ä¸šæ–‡æ¡£è¯­ä¹‰æœç´¢ + å¿«é€Ÿé—®ç­”

### 6.18 åœºæ™¯ä¸ç›®æ ‡
- åœºæ™¯ï¼šä¼ä¸šå†…éƒ¨æœ‰å¤šæºæ–‡æ¡£ï¼ˆéœ€æ±‚ã€è®¾è®¡ã€APIã€å‘¨æŠ¥ã€FAQï¼‰ï¼Œå‘˜å·¥å¸Œæœ›â€œåƒé—®åŒäº‹ä¸€æ ·â€æœç´¢ç­”æ¡ˆ
- ç›®æ ‡ï¼š
  - é«˜è´¨é‡å¬å›ï¼ˆæ··åˆæœç´¢ + MMR + Rerankï¼‰
  - å¯è¿½æº¯ï¼ˆè¿”å›å¼•ç”¨æ¥æºï¼‰
  - ç§»åŠ¨ç«¯å‹å¥½ï¼ˆå“åº”å¼ç•Œé¢ï¼‰
  - é”™è¯¯å¯æ¢å¤ï¼ˆæ£€ç´¢ä¸ºç©ºã€è¶…æ—¶é‡è¯•ã€æœåŠ¡é™çº§ï¼‰

### 6.19 ç›®å½•ç»“æ„
```
src/
  ch06/
    loaders.ts       # æ–‡æ¡£åŠ è½½
    chunk.ts         # æ¸…æ´—åˆ†å—
    chroma-basic.ts  # å‘é‡åº“
    retriever-basic.ts
    hybrid.ts
    rag-qa.ts
app/
  api/search/route.ts
  api/qa/route.ts
  search/page.tsx
  qa/page.tsx
```

### 6.20 QA APIï¼ˆåŸºäº RAGï¼‰
```typescript
// æ–‡ä»¶ï¼šsrc/app/api/qa/route.ts
import { NextRequest } from "next/server";
import { buildQA } from "@/src/ch06/rag-qa";

export const runtime = "edge";

export async function POST(req: NextRequest) {
  const { q } = await req.json();
  const qa = await buildQA();
  try {
    const out = await qa(q);
    return Response.json({ ok: true, data: out });
  } catch (e: any) {
    return Response.json({ ok: false, message: e.message }, { status: 500 });
  }
}
```

### 6.21 å‰ç«¯ QA é¡µ
```tsx
// æ–‡ä»¶ï¼šsrc/app/qa/page.tsx
"use client";
import { useState } from "react";

export default function QA() {
  const [q, setQ] = useState("");
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState("");

  const ask = async () => {
    try {
      setLoading(true); setErr("");
      const res = await fetch("/api/qa", { method: "POST", body: JSON.stringify({ q }) });
      const json = await res.json();
      if (!json.ok) throw new Error(json.message || "unknown");
      setData(json.data);
    } catch (e: any) {
      setErr(e.message);
    } finally { setLoading(false); }
  };

  return (
    <main className="mx-auto max-w-screen-sm p-4">
      <div className="flex gap-2">
        <input className="flex-1 border rounded px-3 py-2" placeholder="æé—®ï¼šä¾‹å¦‚ å‘é‡æ£€ç´¢å¦‚ä½•åš MMRï¼Ÿ" value={q} onChange={e=>setQ(e.target.value)} />
        <button className="px-4 py-2 bgé»‘ text-white rounded" onClick={ask} disabled={loading}>æé—®</button>
      </div>
      {err && <p className="text-red-600 mt-2">{err}</p>}
      {data && (
        <section className="mt-4 space-y-3">
          <h2 className="font-semibold">å›ç­”</h2>
          <div className="whitespace-pre-wrap leading-relaxed">{data.answer}</div>
          <h3 className="font-semibold mt-2">å¼•ç”¨</h3>
          <ul className="list-disc pl-5">
            {data.quotes?.map((t: string, i: number) => (<li key={i}>{t}</li>))}
          </ul>
        </section>
      )}
    </main>
  );
}
```

### 6.22 ç”Ÿäº§çº§ä¼˜åŒ–
- å‘é‡æ‰¹å¤„ç†ï¼š`embeddings.embedDocuments` ä¸€æ¬¡æ€§å¤„ç† N æ¡ï¼Œé™ä½è¯·æ±‚å¼€é”€
- ç¼“å­˜ï¼šå¯¹â€œç›¸åŒæ–‡æœ¬â€çš„å‘é‡åšç¼“å­˜ï¼ˆkey=æ–‡æœ¬æŒ‡çº¹ï¼‰ï¼Œé¿å…é‡å¤è®¡ç®—
- è¿‡æ»¤ä¸æƒé™ï¼šæ£€ç´¢å‰æŒ‰éƒ¨é—¨/è§’è‰²è¿‡æ»¤ Metadataï¼Œé˜²æ­¢è¶Šæƒ
- é™çº§ï¼šå‘é‡åº“ä¸å¯ç”¨æ—¶ï¼Œå›é€€å…³é”®è¯æœç´¢ï¼›Rerank å¼‚å¸¸æ—¶è·³è¿‡é‡æ’
- æ—¥å¿—ä¸ç›‘æ§ï¼šè®°å½• TopK å‘½ä¸­ç‡ã€QA å‘½ä¸­ç‡ã€å¹³å‡å»¶è¿Ÿã€token æˆæœ¬
- æˆæœ¬æ§åˆ¶ï¼šé€‰æ‹©åˆé€‚çš„å‘é‡æ¨¡å‹ï¼ˆä¾‹å¦‚ text-embedding-3-small vs largeï¼‰

### 6.23 é”™è¯¯å¤„ç†æ¸…å•
- åŠ è½½å¤±è´¥ï¼šè·¯å¾„/æƒé™ â†’ è¿”å›å…·ä½“é”™è¯¯ä¸æ’æŸ¥å»ºè®®
- ç©ºæ£€ç´¢ï¼šæç¤ºç¼©å°èŒƒå›´ã€ç»™å‡ºç¤ºä¾‹é—®é¢˜
- è¶…æ—¶ï¼šé‡è¯• + æŒ‡æ•°é€€é¿ + UI ä¾§â€œé‡è¯•â€å…¥å£
- è¾“å‡ºç»“æ„ï¼šå¯¹ QA è¾“å‡ºåš JSON è§£æå¤±è´¥æ—¶çš„å…œåº•ï¼ˆå±•ç¤ºçº¯æ–‡æœ¬ï¼‰

---

## ğŸ“ˆ è¯„æµ‹ä¸è´¨é‡
- æ„å»º Golden Setï¼ˆçœŸå®å¸¸è§é—®é¢˜ + æ ‡å‡†ç­”æ¡ˆ + å¼•ç”¨æ¥æºï¼‰
- è¯„æµ‹æŒ‡æ ‡ï¼šTopK Recallã€MRRã€Rerank ç²¾åº¦ã€QA BLEU/ROUGEã€äººå·¥è¯„åˆ†
- A/Bï¼šä¸åŒåˆ†å—å¤§å°/overlapã€ä¸åŒ TopKã€æ˜¯å¦ MMRã€ä¸åŒ Embedding æ¨¡å‹
- çº¿ä¸Šå›æ”¾ï¼šå¯¹â€œæ— ç­”æ¡ˆ/ä½æ»¡æ„åº¦â€æ ·ä¾‹åšå®šä½å¹¶ä¿®å¤ï¼ˆæ”¹åˆ†å—/ä¸°å¯Œæ–‡æ¡£/è°ƒæ£€ç´¢ï¼‰

---

## ğŸ“š å»¶ä¼¸èµ„æº
- LangChain.jsï¼š`https://js.langchain.com/`
- å‘é‡æ•°æ®åº“ Chromaï¼š`https://docs.trychroma.com/`
- Pineconeï¼š`https://docs.pinecone.io/`
- Weaviateï¼š`https://weaviate.io/developers/weaviate`
- å‘é‡æ£€ç´¢ç†è®ºç»¼è¿°ï¼ˆå¯æœç´¢â€œdense retrieval surveyâ€ï¼‰

---

## âœ… æœ¬ç« å°ç»“
- æŒæ¡äº†å‘é‡åŒ–çš„æ ¸å¿ƒæ¦‚å¿µã€åˆ†å—ç­–ç•¥ä¸ç›¸ä¼¼åº¦åº¦é‡
- ä¼šç”¨ LangChain.js é›†æˆå‘é‡æ•°æ®åº“å¹¶å®ç° TopK/MMR/è¿‡æ»¤/æ··åˆæœç´¢
- å®Œæˆäº†â€œä¼ä¸šæ–‡æ¡£è¯­ä¹‰æœç´¢ + å¿«é€Ÿé—®ç­”â€çš„ç«¯åˆ°ç«¯å®ç°
- çŸ¥é“å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åšæ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯å…œåº•ä¸è´¨é‡è¯„æµ‹

## ğŸ¯ ä¸‹ç« é¢„å‘Š
ä¸‹ä¸€ç« ã€ŠRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ¶æ„è®¾è®¡ä¸å®ç°ã€‹ä¸­ï¼Œæˆ‘ä»¬å°†ï¼š
- ç³»ç»Ÿæ‹†è§£ RAG çš„æ£€ç´¢ã€èåˆä¸ç”Ÿæˆä¸‰å±‚
- å¼•å…¥é‡æ’åºã€å¼•ç”¨æŠ½å–ä¸äº‹å®æ ¡éªŒï¼Œé™ä½å¹»è§‰
- æ„å»ºå¯æ‰©å±•çš„ RAG Pipeline ä¸ç›‘æ§è¯„æµ‹ä½“ç³»

> æœ€åæ„Ÿè°¢é˜…è¯»ï¼æ¬¢è¿å…³æ³¨æˆ‘ï¼Œå¾®ä¿¡å…¬ä¼—å·ï¼š`ã€Šé²«å°é±¼ä¸æ­£ç»ã€‹`ã€‚æ¬¢è¿ç‚¹èµã€æ”¶è—ã€å…³æ³¨ï¼Œä¸€é”®ä¸‰è¿ï¼ï¼ï¼
